rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public university metadata (used during signup)
    match /universities/{uni} {
      // Allow anyone to read university docs and subcollections (domains, allowed_ids, departments, sections)
      allow read: if true;

      // Only super-admins or this university's admins can write university docs
      allow write: if request.auth != null &&
        (exists(/databases/$(database)/documents/super_admins/$(request.auth.uid))
         || exists(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)));

      // Timetables: allow writes by super-admins or by university/admins
      // Dept-level admins are allowed to write timetables for their dept only.
      match /timetables/{tt} {
        allow read: if true;
        allow write: if request.auth != null && (
          // super-admins can always write
          exists(/databases/$(database)/documents/super_admins/$(request.auth.uid)) ||
          // university admin document can allow uni-wide or dept-scoped admin
          (exists(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)) &&
            (
              // either the admin doc has no deptId (uni admin) OR matches the timetable's departmentId
              get(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)).data.deptId == null ||
              get(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)).data.deptId == request.resource.data.departmentId
            )
          )
        );
      }

      // Marketplace items: allow students belonging to this university to create items.
      // Admins and super-admins can create/update/delete. Owners can update/delete their own items.

      match /marketplace_items/{itemId} {
        allow read: if true;

        // Create: only allow if authenticated and one of:
        // - super-admin
        // - university admin for this university
        // - regular user whose users/{uid}.uniId matches this university AND
        //   the posted document's `uid` equals the authenticated uid
        allow create: if request.auth != null && (
          // super-admin
          exists(/databases/$(database)/documents/super_admins/$(request.auth.uid)) ||
          // university admin
          exists(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)) ||
          // regular user must belong to this university and must not impersonate another uid
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.uniId == uni &&
            request.resource.data.uid == request.auth.uid
          )
        );

        // Update/delete: owner, university admin, or super-admin
        allow update, delete: if request.auth != null && (
          request.auth.uid == resource.data.uid ||
          exists(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)) ||
          exists(/databases/$(database)/documents/super_admins/$(request.auth.uid))
        );
      }

      // Other subcollections under universities follow the same permissions as before
      match /{subCollection=**} {
        allow read: if true;
        allow write: if request.auth != null &&
          (exists(/databases/$(database)/documents/super_admins/$(request.auth.uid))
           || exists(/databases/$(database)/documents/universities/$(uni)/admins/$(request.auth.uid)));
      }
    }

    // Users: allow per-doc reads for owner, super-admins, and university admins (uni-admins limited to same uni)
    match /users/{userId} {
      // allow a user to create their own doc
      allow create: if request.auth != null && request.auth.uid == userId;

      // allow reading a single user doc if:
      // - the owner, or
      // - a super-admin, or
      // - a university admin for the user's uni (checks the target doc's uniId)
      allow get: if request.auth != null && (
        request.auth.uid == userId ||
        exists(/databases/$(database)/documents/super_admins/$(request.auth.uid)) ||
        (resource.data.uniId != null &&
         exists(/databases/$(database)/documents/universities/$(resource.data.uniId)/admins/$(request.auth.uid)))
      );

      // allow listing / querying / listing all users only for super-admins
      allow list: if request.auth != null &&
        exists(/databases/$(database)/documents/super_admins/$(request.auth.uid));

      // allow updates/deletes only by owner or super-admin
      allow update, delete: if request.auth != null && (
        request.auth.uid == userId ||
        exists(/databases/$(database)/documents/super_admins/$(request.auth.uid))
      );
    }

    // Super-admin list: only existing super-admins can update
    match /super_admins/{uid} {
      allow read: if request.auth != null && exists(/databases/$(database)/documents/super_admins/$(request.auth.uid));
      allow write: if request.auth != null && exists(/databases/$(database)/documents/super_admins/$(request.auth.uid));
    }

    // Default: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
